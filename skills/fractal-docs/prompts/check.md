---
description: Check fractal documentation consistency
---

# 分形文档一致性检查

验证三层文档体系的完整性和一致性。

## 执行步骤

### 1. 扫描项目结构

列出所有源码目录和源码文件。

排除：
- 构建产物目录（`target/`, `dist/`, `build/`, `node_modules/`）
- 隐藏目录（`.git/`, `.vscode/`, `.idea/`）
- 非源码文件（配置、文档、数据、资源文件）

### 2. 检查第一层：三行头部注释

对每个源码文件检查：

- [ ] 文件是否有 INPUT/OUTPUT/POS 三行注释
- [ ] 注释位置是否正确（在 import/include 之前）
- [ ] 注释格式是否标准（`// INPUT:  ...` 两空格对齐）

输出缺失列表：

```
缺少三行注释的文件：
- src/new_file.rs
- src/utils/helper.py
```

### 3. 检查第二层：目录级 AGENTS.md

对每个包含源码文件的目录检查：

- [ ] 是否存在 `AGENTS.md`
- [ ] 是否存在 `CLAUDE.md`？→ 需区分处理：
  - 仅包含 AGENTS.md 引用/软链接 → 应删除
  - 包含用户自定义约束 → 不要动它，保持原样
- [ ] 是否包含必要章节（地位、逻辑、约束、业务域清单）
- [ ] 业务域清单是否与目录内实际文件一一对应：
  - 清单中列出但实际不存在的文件 → **幽灵条目**
  - 实际存在但清单中未列出的文件 → **遗漏条目**

输出不一致列表：

```
AGENTS.md 不一致：
- src/AGENTS.md:
  - 幽灵条目: old_module.rs（文件已删除）
  - 遗漏条目: new_module.rs（文件未登记）
- src/menu/AGENTS.md: OK
- src/: 存在 CLAUDE.md（仅引用 AGENTS.md，可删除）
- lib/: 存在 CLAUDE.md（包含用户自定义约束，不要动）
```

### 4. 检查第三层：级联完整性

从叶子目录到根目录，检查引用链：

- [ ] 每个子目录在其父目录的 AGENTS.md 业务域清单中有对应条目
- [ ] 根 AGENTS.md 的业务域清单覆盖所有一级源码目录

输出断链列表：

```
级联断链：
- src/utils/ 未在 src/AGENTS.md 的业务域清单中登记
```

### 5. 生成报告

汇总所有检查结果：

```markdown
## 分形文档一致性报告

### 统计
- 源码文件：{N} 个
- 有头部注释：{M} 个（{M/N*100}%）
- 源码目录：{D} 个
- 有 AGENTS.md：{C} 个（{C/D*100}%）

### 问题
- 缺少头部注释：{count} 个文件
- 缺少 AGENTS.md：{count} 个目录
- CLAUDE.md 仅引用 AGENTS.md：{count} 个（可删除）
- CLAUDE.md 含用户自定义约束：{count} 个（保持原样）
- 幽灵条目：{count} 条
- 遗漏条目：{count} 条
- 级联断链：{count} 处

### 修复建议
1. ...
2. ...
```

## 输出

- 如果全部通过：输出简短确认
- 如果有问题：输出报告 + 询问是否自动修复

## 自动修复

如果用户同意自动修复：

- **缺少头部注释**：阅读文件 → 添加注释
- **缺少 AGENTS.md**：分析目录 → 生成 AGENTS.md
- **CLAUDE.md 仅引用 AGENTS.md**：直接删除
- **CLAUDE.md 含用户自定义约束**：不要动，保持原样
- **幽灵条目**：从清单中删除
- **遗漏条目**：阅读文件 → 添加到清单
- **级联断链**：添加缺失的父级条目

修复后再次运行检查，确认全部通过。
