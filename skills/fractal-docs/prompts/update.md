---
description: Update fractal documentation after file changes
---

# 分形文档级联更新

文件变更后，按级联规则更新相关文档。

参数：`$ARGUMENTS`（可选，指定文件路径。为空时自动检测变更）

## 执行步骤

### 1. 检测变更

**如果指定了文件路径：**
直接处理该文件。

**如果未指定文件：**
```bash
git diff --name-status HEAD
git diff --name-status --cached
```

从输出中识别：
- `A` = 新增文件
- `D` = 删除文件
- `M` = 修改文件
- `R` = 重命名文件

过滤出源码文件（排除 `*.md`, `*.json`, `*.lock`, `*.toml` 项目配置等）。

### 2. 按变更类型处理

#### 新增文件 (A)

1. 阅读新文件内容
2. 添加三行头部注释（参考 `knowledge/header-patterns.md`）
3. 更新所在目录的 `CLAUDE.md` 业务域清单（添加一行）
4. 检查上级目录的 `CLAUDE.md` 是否需要更新

#### 删除文件 (D)

1. 更新所在目录的 `CLAUDE.md` 业务域清单（删除对应行）
2. 如果目录为空（所有源码文件被删除），删除该目录的 `CLAUDE.md`
3. 检查上级目录的 `CLAUDE.md` 是否需要更新

#### 修改文件 (M)

1. 阅读修改后的文件
2. 检查变更是否涉及 **接口/职责变化**：
   - 新增/删除/重命名了公开 API？→ 更新 OUTPUT
   - 新增/删除了依赖？→ 更新 INPUT
   - 模块职责变了？→ 更新 POS
3. 如果只是内部实现变更：
   - 检查三行注释是否仍然准确
   - 不更新目录级 CLAUDE.md
4. 如果接口/职责变了：
   - 更新三行注释
   - 更新所在目录的 CLAUDE.md（职责描述）
   - 检查上级是否需要更新

#### 重命名文件 (R)

1. 更新所在目录 CLAUDE.md 清单中的文件名
2. 如果跨目录移动：更新旧目录和新目录的 CLAUDE.md
3. 检查文件内三行注释是否仍准确

### 3. 级联向上检查

对每个被更新的 `CLAUDE.md`，检查其父目录的 `CLAUDE.md`：
- 业务域清单中该子目录的描述是否需要更新
- 递归直到根 `CLAUDE.md`

### 4. 验证

运行构建命令确认未破坏编译。

## 输出

列出所有更新的文件：

```
已更新：
- src/new_module.rs          (添加三行注释)
- src/CLAUDE.md              (更新业务域清单：+new_module)
- CLAUDE.md                  (更新业务域清单：src/ 描述调整)
```

## 注意事项

- **最小变更原则**：只更新确实需要变更的文档，不要过度更新
- **内部实现不触发更新**：仅重构/优化内部逻辑时，不更新目录级文档
- **不确定时不更新**：如果无法判断接口是否变了，保持现状
