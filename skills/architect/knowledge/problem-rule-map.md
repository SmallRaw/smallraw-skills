# 问题-规则映射表

> 当遇到问题时，查阅此表找到对应的规则。

---

## 快速索引

| 问题关键词 | 跳转 |
|-----------|------|
| 提交、commit、git add | [安全规则 S1-S3](#安全规则) |
| 覆盖、丢失、冲突 | [协作规则 M1-M8](#协作规则) |
| PR、合并、review | [流程规则 P1-P8](#流程规则) |
| 格式、风格、命名 | [风格规则 C1-C6](#风格规则) |
| 找不到、不知道 | [知识规则 K1-K8](#知识规则) |

---

## 安全规则

### S1: 禁止 git add . / git add -A

| 项目 | 内容 |
|------|------|
| **问题信号** | "提交了不该提交的文件"、"提交了 .env"、"提交了 node_modules" |
| **根本原因** | `git add .` 会暂存所有文件，包括敏感文件和大文件 |
| **规则** | 禁止使用 `git add .` 和 `git add -A`，使用 `scripts/committer` 或明确指定文件 |
| **自动化** | committer 脚本会拒绝 "." 参数 |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

### S2: 禁止编辑 node_modules

| 项目 | 内容 |
|------|------|
| **问题信号** | "改了依赖但又没了"、"npm install 后改动消失" |
| **根本原因** | node_modules 会被 npm/pnpm install 覆盖 |
| **规则** | 永远不要编辑 node_modules，使用 patch 或 fork |
| **自动化** | committer 脚本会拒绝 node_modules 路径 |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有 Node.js 项目适用 |

### S3: 禁止提交敏感信息

| 项目 | 内容 |
|------|------|
| **问题信号** | "泄露了 API key"、"提交了真实手机号" |
| **根本原因** | 敏感信息进入 git 历史后很难完全清除 |
| **规则** | 使用 placeholder 替代真实数据，检查 .gitignore |
| **自动化** | 可使用 detect-secrets pre-commit hook |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

### S4: 版本号修改需要批准

| 项目 | 内容 |
|------|------|
| **问题信号** | "发布了不该发布的版本"、"版本号改错了" |
| **根本原因** | 版本号影响发布，误改可能导致问题 |
| **规则** | 修改版本号前必须获得明确批准 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有有发布的项目适用 |

### S5: Patch 依赖使用精确版本

| 项目 | 内容 |
|------|------|
| **问题信号** | "patch 应用失败"、"patch 和版本不匹配" |
| **根本原因** | patch 针对特定版本，版本升级后可能失效 |
| **规则** | 有 patch 的依赖必须用精确版本（无 ^ ~） |
| **自动化** | 可在 CI 中检查 |
| **通用程度** | ⭐⭐⭐⭐ 使用 patch 的项目适用 |

---

## 协作规则

### M1: 禁止 git stash

| 项目 | 内容 |
|------|------|
| **问题信号** | "我的改动不见了"、"stash 被覆盖了"、"stash 冲突" |
| **根本原因** | 多个 Agent/人同时使用 stash 会互相覆盖 |
| **规则** | 禁止 git stash，除非用户明确要求 |
| **自动化** | 可加 pre-commit hook 检测 |
| **通用程度** | ⭐⭐⭐⭐⭐ 多 Agent 协作必备 |

### M2: 禁止切换分支

| 项目 | 内容 |
|------|------|
| **问题信号** | "分支被切走了"、"我在错误的分支上" |
| **根本原因** | 切换分支会影响其他 Agent 的工作上下文 |
| **规则** | 禁止切换分支，除非用户明确要求 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐⭐ 多 Agent 协作必备 |

### M3: 禁止修改 worktree

| 项目 | 内容 |
|------|------|
| **问题信号** | "worktree 被删了"、"worktree 配置乱了" |
| **根本原因** | worktree 是共享资源 |
| **规则** | 禁止创建/删除/修改 worktree，除非用户明确要求 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐⭐ 使用 worktree 的项目适用 |

### M4: Commit 只 scope 自己的改动

| 项目 | 内容 |
|------|------|
| **问题信号** | "我的 WIP 被提交了"、"提交了不该提交的文件" |
| **根本原因** | 多 Agent 同时工作，可能有未完成的改动 |
| **规则** | commit 时只提交自己明确修改的文件 |
| **自动化** | committer 脚本强制指定文件 |
| **通用程度** | ⭐⭐⭐⭐⭐ 多 Agent 协作必备 |

### M5: 看到不认识的文件，继续工作

| 项目 | 内容 |
|------|------|
| **问题信号** | "Agent 因为未知文件停止了"、"Agent 问要不要处理别的文件" |
| **根本原因** | 其他 Agent 可能正在工作 |
| **规则** | 看到不认识的文件，忽略它，专注自己的任务 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐ 多 Agent 协作适用 |

### M6: 报告只关注自己的改动

| 项目 | 内容 |
|------|------|
| **问题信号** | "报告太长了"、"报告包含无关信息" |
| **根本原因** | Agent 报告了不相关的内容 |
| **规则** | 报告只描述自己做了什么，不描述看到了什么 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐ 多 Agent 协作适用 |

### M7: 多 Agent 各自独立 session

| 项目 | 内容 |
|------|------|
| **问题信号** | "session 冲突"、"上下文混乱" |
| **根本原因** | 共享 session 导致状态混乱 |
| **规则** | 每个 Agent 使用独立的 session |
| **自动化** | 由 Agent 框架保证 |
| **通用程度** | ⭐⭐⭐⭐ 多 Agent 协作适用 |

### M8: Push 时可以 rebase

| 项目 | 内容 |
|------|------|
| **问题信号** | "push 失败因为落后"、"需要同步远程" |
| **根本原因** | 其他人/Agent 已经推送了新的提交 |
| **规则** | push 时可以 git pull --rebase，但不能丢弃别人的工作 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐ 多人协作适用 |

---

## 流程规则

### P1: 使用 committer 脚本提交

| 项目 | 内容 |
|------|------|
| **问题信号** | "提交了太多文件"、"提交范围失控" |
| **根本原因** | 手动 git add/commit 容易出错 |
| **规则** | 使用 `scripts/committer "<msg>" <files...>` |
| **自动化** | committer 脚本本身 |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

### P2: PR Review 只看不改

| 项目 | 内容 |
|------|------|
| **问题信号** | "审查时意外改了代码"、"不知道改了什么" |
| **根本原因** | Review 模式和 Land 模式混淆 |
| **规则** | Review 模式只用 gh pr view/diff，不改代码不切分支 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐⭐ 有 PR 流程的项目适用 |

### P3: PR Land 使用临时分支

| 项目 | 内容 |
|------|------|
| **问题信号** | "git 历史很乱"、"不知道谁做的改动" |
| **根本原因** | 直接在 main 上改动 |
| **规则** | 创建临时分支 → 合并 PR → 运行 gate → 合回 main → 删临时分支 |
| **自动化** | 无，靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐⭐ 有 PR 流程的项目适用 |

### P4: PR 合并后添加 changelog

| 项目 | 内容 |
|------|------|
| **问题信号** | "不知道这个版本改了什么"、"changelog 不完整" |
| **根本原因** | 忘记更新 changelog |
| **规则** | 每个 PR 合并后添加 changelog 条目，包含 PR 号和贡献者感谢 |
| **自动化** | 可在 CI 中检查 |
| **通用程度** | ⭐⭐⭐⭐ 有发布流程的项目适用 |

### P5: 推送前运行测试

| 项目 | 内容 |
|------|------|
| **问题信号** | "CI 失败了"、"本地没问题 CI 挂了" |
| **根本原因** | 推送前没跑测试 |
| **规则** | `pnpm test` 或等效命令，推送前必须通过 |
| **自动化** | 可用 pre-push hook |
| **通用程度** | ⭐⭐⭐⭐⭐ 有测试的项目适用 |

### P6: Conventional Commits 格式

| 项目 | 内容 |
|------|------|
| **问题信号** | "提交信息看不懂"、"不知道这个提交做了什么" |
| **根本原因** | 提交信息格式不统一 |
| **规则** | `type(scope): description` 格式 |
| **自动化** | 可用 commitlint |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

### P7: Lint/Format 改动自动处理

| 项目 | 内容 |
|------|------|
| **问题信号** | "每次都问要不要处理格式"、"太啰嗦" |
| **根本原因** | 格式改动和逻辑改动混在一起 |
| **规则** | 纯格式改动自动处理，不需要确认 |
| **自动化** | 靠规则约束 |
| **通用程度** | ⭐⭐⭐⭐ 有格式工具的项目适用 |

### P8: 合并前运行完整 Gate

| 项目 | 内容 |
|------|------|
| **问题信号** | "合并后 CI 挂了"、"合并后发现问题" |
| **根本原因** | 合并前没跑完整检查 |
| **规则** | `pnpm lint && pnpm build && pnpm test` 必须全部通过 |
| **自动化** | 可用 CI 强制 |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

---

## 风格规则

### C1: 文件不超过 500 行

| 项目 | 内容 |
|------|------|
| **问题信号** | "这个文件太长了"、"看不懂这个文件" |
| **根本原因** | 文件太大难以理解和维护 |
| **规则** | 单文件不超过 500 行（软限制 700 行） |
| **自动化** | 可用 lint 规则 |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

### C2: 严格类型，避免 any

| 项目 | 内容 |
|------|------|
| **问题信号** | "类型错误"、"运行时报错" |
| **根本原因** | any 绕过了类型检查 |
| **规则** | 禁止使用 any，使用 unknown 或具体类型 |
| **自动化** | TypeScript strict 模式 + lint |
| **通用程度** | ⭐⭐⭐⭐⭐ TypeScript 项目适用 |

### C3: 复杂逻辑添加注释

| 项目 | 内容 |
|------|------|
| **问题信号** | "看不懂这段代码"、"为什么要这样写" |
| **根本原因** | 复杂逻辑没有解释 |
| **规则** | 非显而易见的逻辑添加简短注释 |
| **自动化** | 无，靠 review |
| **通用程度** | ⭐⭐⭐⭐⭐ 所有项目适用 |

---

## 知识规则

### K1: 版本号位置清单

| 项目 | 内容 |
|------|------|
| **问题信号** | "版本号不一致"、"忘了更新某个地方" |
| **根本原因** | 版本号分散在多个文件 |
| **规则** | 文档中列出所有版本号位置 |
| **自动化** | 可写脚本统一更新 |
| **通用程度** | ⭐⭐⭐ 多平台项目适用 |

### K2: 项目结构说明

| 项目 | 内容 |
|------|------|
| **问题信号** | "文件应该放哪里"、"这个目录是干什么的" |
| **根本原因** | 项目结构没有文档 |
| **规则** | AGENTS.md 中说明目录结构 |
| **自动化** | 无 |
| **通用程度** | ⭐⭐⭐⭐ 所有项目适用 |

### K3: 内部术语表

| 项目 | 内容 |
|------|------|
| **问题信号** | "什么是 XXX"、"不理解这个词" |
| **根本原因** | 项目有内部术语 |
| **规则** | 记录内部术语和缩写 |
| **自动化** | 无 |
| **通用程度** | ⭐⭐⭐ 有内部术语的项目适用 |
