# Level 3: 协作规则扩展包

> 当有多个 AI Agent 同时工作，或多人协作时，添加这些规则。
> 触发信号：stash 冲突、分支混乱、提交了别人的代码、工作被覆盖

---

## 添加到 AGENTS.md 的规则

### Multi-agent Safety 章节

```markdown
## Multi-agent Safety

> 假设随时可能有其他 Agent 在工作。遵循以下规则避免冲突。

### Git 操作限制

- **禁止 git stash**（除非用户明确要求）
  为什么：多个 Agent 的 stash 会互相覆盖。
  包括：`git stash`, `git pull --rebase --autostash`

- **禁止切换分支**（除非用户明确要求）
  为什么：会影响其他 Agent 的工作上下文。
  正确做法：在当前分支工作，或请求用户允许。

- **禁止修改 worktree**（除非用户明确要求）
  为什么：worktree 是共享资源。
  包括：创建、删除、修改 `.worktrees/` 下的内容。

### 提交行为

- **commit 只包含自己的改动**
  为什么：其他 Agent 可能有未完成的工作。
  正确做法：明确指定要提交的文件，使用 `scripts/committer`。

- **push 前可以 rebase**
  为什么：需要同步远程的新提交。
  但是：不能丢弃别人的工作，只能 `git pull --rebase`。

### 工作态度

- **看到不认识的文件，忽略它**
  为什么：可能是其他 Agent 正在工作。
  正确做法：专注自己的任务，不要问"要不要处理这个文件"。

- **报告只关注自己的改动**
  为什么：避免报告太长太杂。
  正确做法：描述自己做了什么，不描述看到了什么。

- **遇到冲突时，保守处理**
  为什么：不确定其他 Agent 的意图。
  正确做法：停下来询问用户，不要自作主张。

### Session 隔离

- 每个 Agent 使用独立的 session。
- 不要假设其他 Agent 的状态。
- 不要依赖全局状态。
```

### 协作 Workflow 章节

```markdown
## Collaboration Workflow

### 分工模式

当多个 Agent 同时工作时：
- 每个 Agent 负责独立的文件/模块
- 避免同时修改同一个文件
- 完成后立即提交，减少冲突窗口

### 冲突处理

当发现冲突时：
1. 停止当前操作
2. 报告冲突情况
3. 等待用户指示
4. 不要自动解决（除非用户授权）

### 通信模式

- 完成任务后简要报告
- 报告格式：做了什么 + 改了哪些文件
- 不需要报告"看到了什么"
```

---

## 常见场景处理

### 场景 1：看到未知改动

```
错误：Agent 问"我看到 xxx 文件有改动，要处理吗？"
正确：Agent 忽略未知改动，专注自己的任务。
```

### 场景 2：Push 失败（落后于远程）

```
错误：git push --force
正确：git pull --rebase && git push
```

### 场景 3：需要暂存当前工作

```
错误：git stash
正确：先提交当前工作，或询问用户如何处理
```

### 场景 4：需要切换到另一个分支

```
错误：直接 git checkout other-branch
正确：询问用户是否允许切换分支
```

---

## 检查清单

添加这个扩展包后，确认：

- [ ] 所有 Agent 都了解这些规则
- [ ] committer 脚本已安装
- [ ] 每个 Agent 有独立的 session
- [ ] 冲突处理流程已明确
