# 规则架构设计

> 这份文档说明规则应该放在哪里、如何组织、如何继承。

---

## 规则层级

```
┌─────────────────────────────────────────────────────────────────┐
│  Layer 0: 全局核心规则                                           │
│  位置: ~/.claude/rules/                                         │
│  性质: 宪法，不可违反，不可覆盖                                    │
│  加载: 每次会话自动加载                                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 继承
┌─────────────────────────────────────────────────────────────────┐
│  Layer 1: 项目规范                                               │
│  位置: {project}/AGENTS.md (或 CLAUDE.md)                       │
│  性质: 法律，可扩展全局规则，可添加项目特定规则                      │
│  加载: 进入项目时自动加载                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 继承
┌─────────────────────────────────────────────────────────────────┐
│  Layer 2: 任务 SOP                                              │
│  位置: {project}/.pi/prompts/                                   │
│  性质: 操作手册，定义具体任务的执行流程                             │
│  加载: 执行特定任务时加载                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 辅助
┌─────────────────────────────────────────────────────────────────┐
│  Layer 3: 规则演进记录                                           │
│  位置: AGENTS.md 底部的 Rules Evolution 表                       │
│  性质: 历史记录，解释为什么有这条规则                               │
│  加载: 需要理解规则时参考                                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 各层详解

### Layer 0: 全局核心规则 (`~/.claude/rules/`)

**特点：**
- 适用于所有项目
- 绝对不能违反
- 项目规则不能覆盖

**目录结构：**
```
~/.claude/rules/
├── core.md          # 核心安全规则
├── git-safety.md    # Git 操作安全
├── multi-agent.md   # 多 Agent 协作
└── {lang}.md        # 语言特定规则（可选）
```

**适合放这里的规则：**
- 禁止 `git add .`
- 禁止编辑 `node_modules`
- 禁止提交敏感信息
- 禁止 `git stash`（多 Agent）
- 禁止切换分支（多 Agent）

**规则强度标记：**
- `MUST` / `禁止` / `必须` → 硬性规则
- 这一层的规则都是 MUST 级别

---

### Layer 1: 项目规范 (`AGENTS.md`)

**特点：**
- 适用于当前项目
- 可以扩展全局规则
- 可以添加项目特定规则
- 不能削弱全局规则

**标准章节结构：**
```markdown
# Repository Guidelines

## Project Structure
## Build & Dev Commands
## Coding Style
## Testing
## Commit & PR
## Security
## Agent Notes
## Multi-agent Safety（如果需要）
## Rules Evolution（规则演进记录）
```

**适合放这里的规则：**
- 项目目录结构说明
- 构建和开发命令
- 项目特定的工具使用
- 版本号位置清单
- 项目特定的禁止事项

**规则强度标记：**
- `MUST` → 项目硬性规则
- `SHOULD` → 项目建议规则
- `MAY` → 项目可选规则

---

### Layer 2: 任务 SOP (`.pi/prompts/`)

**特点：**
- 定义具体任务的执行流程
- 被调用时加载
- 继承上层所有规则

**目录结构：**
```
.pi/prompts/
├── pr.md           # PR 审查流程
├── issue.md        # Issue 分析流程
├── changelog.md    # Changelog 审计流程
└── release.md      # 发布流程（可选）
```

**适合放这里的内容：**
- 步骤化的操作流程
- 输出格式模板
- 特定任务的检查清单

**与规则的关系：**
- SOP 是规则的"执行版本"
- 规则说"要做什么"，SOP 说"怎么做"

---

### Layer 3: 规则演进记录

**特点：**
- 记录规则的来源和原因
- 帮助理解为什么有这条规则
- 定期回顾时使用

**位置：**
- AGENTS.md 底部的 `## Rules Evolution` 表
- 或单独的 `.rules-history.md`（如果太长）

**格式：**
```markdown
## Rules Evolution

| 日期 | 规则 | 起因 | 类型 |
|------|------|------|------|
| 2026-02-01 | 初始化 | 项目创建 | - |
| 2026-02-03 | 禁止 git stash | Agent A 和 B 的 stash 互相覆盖 | 安全 |
| 2026-02-05 | 使用 committer | 多次提交了 .env 文件 | 安全 |
```

---

## 规则继承与覆盖

### 继承规则

```
全局规则（MUST）
    ↓ 完全继承，不可覆盖
项目规则（MUST/SHOULD/MAY）
    ↓ 完全继承，可补充
任务 SOP
```

### 覆盖规则

| 场景 | 是否允许 | 说明 |
|------|----------|------|
| 项目覆盖全局 MUST | ❌ 禁止 | 安全规则不可削弱 |
| 项目扩展全局 MUST | ✅ 允许 | 可以更严格 |
| 项目定义新规则 | ✅ 允许 | 项目特定需求 |
| SOP 覆盖项目规则 | ❌ 禁止 | SOP 只是执行流程 |

### 冲突处理

当规则冲突时：
1. 全局 MUST > 项目 MUST > 项目 SHOULD > 项目 MAY
2. 如果不确定，选择更严格的规则
3. 如果仍有疑问，询问用户

---

## 文件命名规范

### 全局规则
```
~/.claude/rules/
├── core.md              # 核心规则（必须有）
├── git-safety.md        # Git 安全
├── multi-agent.md       # 多 Agent
├── typescript.md        # TypeScript 项目
├── python.md            # Python 项目
└── swift.md             # Swift 项目
```

### 项目规则
```
{project}/
├── AGENTS.md            # 主规范文件
├── CLAUDE.md -> AGENTS.md  # 软链接（让 Claude 自动加载）
└── .pi/
    └── prompts/
        ├── pr.md        # PR 审查
        ├── issue.md     # Issue 分析
        └── *.md         # 其他 SOP
```

---

## 不应该进入版本控制的内容

```gitignore
# .gitignore

# Agent 私有记忆
memory/
.memory/
*.memory.md

# Agent 身份（如果使用）
IDENTITY.md
USER.md

# 本地环境配置
TOOLS.md
.tools/

# Session 日志
.sessions/
*.session.json
```

---

## 检查清单

设置新项目时：

- [ ] 全局规则已配置 (`~/.claude/rules/`)
- [ ] AGENTS.md 已创建
- [ ] CLAUDE.md 软链接已创建
- [ ] scripts/committer 已安装
- [ ] .gitignore 已排除私有文件
- [ ] Rules Evolution 表已初始化
